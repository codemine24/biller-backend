generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

// ==================== User Management ====================

model Company {
  id             String        @id @default(uuid())
  name           String
  email          String?
  contact_number String        @unique
  address        String
  status         CompanyStatus @default(HOLD)
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt

  users      User[]
  stores     Store[]
  categories Category[]
  products   Product[]
  customers  Customer[]
  vendors    Vendor[]
  brands     Brand[]

  @@map("companies")
}

model User {
  id                  String     @id @default(uuid())
  name                String
  email               String?    @unique
  contact_number      String     @unique
  password            String
  avatar              String?
  role                UserRole   @default(OWNER)
  status              UserStatus @default(ACTIVE)
  is_deleted          Boolean    @default(false)
  password_changed_at DateTime?
  company_id          String?
  created_at          DateTime   @default(now())
  updated_at          DateTime   @updatedAt

  company          Company?         @relation(fields: [company_id], references: [id])
  purchases        Purchase[]
  sales            Sale[]
  transfers        Transfer[]
  payments_created Payment[]
  ledger_entries   CustomerLedger[]
  purchase_returns PurchaseReturn[] @relation("PurchaseReturnsCreated")
  sale_returns     SaleReturn[]     @relation("SaleReturnsCreated")

  @@map("users")
}

// ==================== Product Management ====================

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  icon        String?
  description String?
  company_id  String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  company  Company   @relation(fields: [company_id], references: [id], onDelete: Cascade)
  products Product[]

  @@map("categories")
}

model Brand {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  logo        String?
  description String?
  company_id  String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  company  Company   @relation(fields: [company_id], references: [id], onDelete: Cascade)
  products Product[]

  @@map("brands")
}

model Product {
  id            String   @id @default(uuid())
  name          String   @unique
  slug          String   @unique
  description   String?
  category_id   String?
  brand_id      String?
  unit          String // e.g., "pcs", "kg", "liter"
  cost_price    Decimal  @default(0) @db.Decimal(10, 2)
  selling_price Decimal  @default(0) @db.Decimal(10, 2)
  reorder_level Int      @default(0)
  company_id    String?
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  company               Company?             @relation(fields: [company_id], references: [id], onDelete: Cascade)
  category              Category?            @relation(fields: [category_id], references: [id], onDelete: SetNull)
  brand                 Brand?               @relation(fields: [brand_id], references: [id])
  inventory             Inventory[]
  purchase_items        PurchaseItem[]
  sale_items            SaleItem[]
  transfer_items        TransferItem[]
  purchase_return_items PurchaseReturnItem[]
  sale_return_items     SaleReturnItem[]

  @@map("products")
}

// ==================== Store & Inventory Management ====================

model Store {
  id             String   @id @default(uuid())
  name           String
  location       String
  contact_number String?
  company_id     String
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  company          Company          @relation(fields: [company_id], references: [id], onDelete: Cascade)
  inventory        Inventory[]
  purchases        Purchase[]
  sales            Sale[]
  transfers_from   Transfer[]       @relation("TransferFrom")
  transfers_to     Transfer[]       @relation("TransferTo")
  purchase_returns PurchaseReturn[]
  sale_returns     SaleReturn[]

  @@map("stores")
}

model Inventory {
  id           String   @id @default(uuid())
  product_id   String
  store_id     String
  quantity     Int      @default(0)
  last_updated DateTime @updatedAt
  created_at   DateTime @default(now())

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)
  store   Store   @relation(fields: [store_id], references: [id], onDelete: Cascade)

  @@unique([product_id, store_id])
  @@map("inventory")
}

// ==================== Purchase Management ====================

model Purchase {
  id             String         @id @default(uuid())
  invoice_number String         @unique
  vendor_id      String
  store_id       String
  purchase_date  DateTime       @default(now())
  total_amount   Decimal        @default(0) @db.Decimal(12, 2)
  paid_amount    Decimal        @default(0) @db.Decimal(12, 2)
  due_amount     Decimal        @default(0) @db.Decimal(12, 2)
  status         PurchaseStatus @default(PENDING)
  notes          String?
  creator_id     String
  created_at     DateTime       @default(now())
  updated_at     DateTime       @updatedAt

  vendor           Vendor           @relation(fields: [vendor_id], references: [id])
  store            Store            @relation(fields: [store_id], references: [id])
  created_by       User             @relation(fields: [creator_id], references: [id])
  items            PurchaseItem[]
  payments         Payment[]
  purchase_returns PurchaseReturn[]

  @@map("purchases")
}

model PurchaseItem {
  id          String   @id @default(uuid())
  purchase_id String
  product_id  String
  quantity    Int
  unit_price  Decimal  @db.Decimal(10, 2)
  total_price Decimal  @db.Decimal(12, 2)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  purchase Purchase @relation(fields: [purchase_id], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [product_id], references: [id])

  @@map("purchase_items")
}

model PurchaseReturn {
  id            String       @id @default(uuid())
  return_number String       @unique
  purchase_id   String
  store_id      String
  return_date   DateTime     @default(now())
  reason        String
  refund_amount Decimal      @default(0) @db.Decimal(12, 2)
  status        ReturnStatus @default(PENDING)
  notes         String?
  creator_id    String
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  purchase   Purchase             @relation(fields: [purchase_id], references: [id])
  store      Store                @relation(fields: [store_id], references: [id])
  created_by User                 @relation("PurchaseReturnsCreated", fields: [creator_id], references: [id])
  items      PurchaseReturnItem[]

  @@map("purchase_returns")
}

model PurchaseReturnItem {
  id                 String   @id @default(uuid())
  purchase_return_id String
  product_id         String
  quantity           Int
  unit_price         Decimal  @db.Decimal(10, 2)
  total_price        Decimal  @db.Decimal(12, 2)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  purchase_return PurchaseReturn @relation(fields: [purchase_return_id], references: [id], onDelete: Cascade)
  product         Product        @relation(fields: [product_id], references: [id])

  @@map("purchase_return_items")
}

// ==================== Sales Management ====================

model Sale {
  id             String     @id @default(uuid())
  invoice_number String     @unique
  customer_id    String?
  store_id       String
  sale_date      DateTime   @default(now())
  subtotal       Decimal    @default(0) @db.Decimal(12, 2)
  discount       Decimal    @default(0) @db.Decimal(10, 2)
  tax            Decimal    @default(0) @db.Decimal(10, 2)
  total_amount   Decimal    @default(0) @db.Decimal(12, 2)
  paid_amount    Decimal    @default(0) @db.Decimal(12, 2)
  due_amount     Decimal    @default(0) @db.Decimal(12, 2)
  status         SaleStatus @default(COMPLETED)
  notes          String?
  creator_id     String
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt

  customer       Customer?        @relation(fields: [customer_id], references: [id])
  store          Store            @relation(fields: [store_id], references: [id])
  created_by     User             @relation(fields: [creator_id], references: [id])
  items          SaleItem[]
  payments       Payment[]
  ledger_entries CustomerLedger[]
  sale_returns   SaleReturn[]

  @@map("sales")
}

model SaleItem {
  id          String   @id @default(uuid())
  sale_id     String
  product_id  String
  quantity    Int
  unit_price  Decimal  @db.Decimal(10, 2)
  total_price Decimal  @db.Decimal(12, 2)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  sale    Sale    @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id])

  @@map("sale_items")
}

model SaleReturn {
  id            String       @id @default(uuid())
  return_number String       @unique
  sale_id       String
  store_id      String
  return_date   DateTime     @default(now())
  reason        String
  refund_amount Decimal      @default(0) @db.Decimal(12, 2)
  status        ReturnStatus @default(PENDING)
  notes         String?
  creator_id    String
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  sale       Sale             @relation(fields: [sale_id], references: [id])
  store      Store            @relation(fields: [store_id], references: [id])
  created_by User             @relation("SaleReturnsCreated", fields: [creator_id], references: [id])
  items      SaleReturnItem[]

  @@map("sale_returns")
}

model SaleReturnItem {
  id             String   @id @default(uuid())
  sale_return_id String
  product_id     String
  quantity       Int
  unit_price     Decimal  @db.Decimal(10, 2)
  total_price    Decimal  @db.Decimal(12, 2)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  sale_return SaleReturn @relation(fields: [sale_return_id], references: [id], onDelete: Cascade)
  product     Product    @relation(fields: [product_id], references: [id])

  @@map("sale_return_items")
}

// ==================== Transfer Management ====================

model Transfer {
  id              String         @id @default(uuid())
  transfer_number String         @unique
  from_store_id   String
  to_store_id     String
  transfer_date   DateTime       @default(now())
  status          TransferStatus @default(PENDING)
  notes           String?
  creator_id      String
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt

  from_store Store          @relation("TransferFrom", fields: [from_store_id], references: [id])
  to_store   Store          @relation("TransferTo", fields: [to_store_id], references: [id])
  created_by User           @relation(fields: [creator_id], references: [id])
  items      TransferItem[]

  @@map("transfers")
}

model TransferItem {
  id          String   @id @default(uuid())
  transfer_id String
  product_id  String
  quantity    Int
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  transfer Transfer @relation(fields: [transfer_id], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [product_id], references: [id])

  @@map("transfer_items")
}

// ==================== Customer & Vendor Management =====================

model Customer {
  id             String   @id @default(uuid())
  name           String
  email          String?
  contact_number String
  address        String?
  company_id     String
  total_due      Decimal  @default(0) @db.Decimal(12, 2)
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  company        Company          @relation(fields: [company_id], references: [id], onDelete: Cascade)
  sales          Sale[]
  ledger_entries CustomerLedger[]

  @@map("customers")
}

model Vendor {
  id             String   @id @default(uuid())
  name           String
  email          String?
  contact_number String
  address        String?
  company_id     String
  total_due      Decimal  @default(0) @db.Decimal(12, 2)
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  company   Company    @relation(fields: [company_id], references: [id], onDelete: Cascade)
  purchases Purchase[]

  @@map("vendors")
}

// ==================== Payment & Ledger Management ====================

model Payment {
  id             String        @id @default(uuid())
  payment_number String        @unique
  transaction_id String? // For reference transactions
  amount         Decimal       @db.Decimal(12, 2)
  payment_method PaymentMethod
  payment_date   DateTime      @default(now())
  payment_type   PaymentType // RECEIVED or PAID
  reference_type ReferenceType // SALE or PURCHASE
  reference_id   String // ID of Sale or Purchase
  notes          String?
  creator_id     String
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt

  created_by User      @relation(fields: [creator_id], references: [id])
  purchase   Purchase? @relation(fields: [purchaseId], references: [id])
  purchaseId String?
  sale       Sale?     @relation(fields: [saleId], references: [id])
  saleId     String?

  @@map("payments")
}

model CustomerLedger {
  id          String     @id @default(uuid())
  customer_id String
  sale_id     String?
  type        LedgerType // DEBIT or CREDIT
  amount      Decimal    @db.Decimal(12, 2)
  balance     Decimal    @db.Decimal(12, 2)
  description String
  creator_id  String
  created_at  DateTime   @default(now())

  customer   Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  sale       Sale?    @relation(fields: [sale_id], references: [id])
  created_by User     @relation(fields: [creator_id], references: [id])

  @@map("customer_ledger")
}

// ==================== Enums ====================

enum UserRole {
  SUPER_ADMIN
  OWNER
  ADMIN
  BRANCH_MANAGER
  SALESMAN
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum CompanyStatus {
  ACTIVE
  BLOCKED
  HOLD
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum SaleStatus {
  COMPLETED
  CANCELLED
  RETURNED
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  MOBILE_BANKING
  CHEQUE
}

enum PaymentType {
  RECEIVED
  PAID
}

enum ReferenceType {
  SALE
  PURCHASE
}

enum LedgerType {
  DEBIT
  CREDIT
}

enum ReturnStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}
